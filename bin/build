#!/usr/bin/env bash
set -euo pipefail

bp_dir="${CNB_BUILDPACK_DIR:?}"
app_dir="${CNB_APP_DIR:?}"
layers_dir="${CNB_LAYERS_DIR:?}"

bun_layer="$layers_dir/bun"

BUN_VERSION="${BP_BUN_VERSION:-1.1.0}" # you can override via env

mkdir -p "$bun_layer/bin" "$bun_layer/env"

# --- Install Bun (choose ONE approach) ---
# Approach A (recommended): download bun binary from official releases / installer
# - You can vendor an installer script, or curl bun.sh/install, or fetch GitHub release asset.
# Keep it deterministic with BP_BUN_VERSION.

if [[ ! -f "$bun_layer/bin/bun" ]]; then
  echo "Installing Bun $BUN_VERSION into layer..."

  # Example placeholder:
  # curl -fsSL https://bun.sh/install | bash -s -- --version "$BUN_VERSION" --no-progress
  #
  # Then copy the installed bun binary into "$bun_layer/bin/bun"

  # For now, fail with a clear message if you haven't wired download yet:
  echo "ERROR: Bun download/install not implemented. Wire BP_BUN_VERSION -> bun binary install." >&2
  exit 1
fi

chmod +x "$bun_layer/bin/bun"

# --- Export PATH so subsequent buildpacks (and launch) can see bun ---
echo -n "$bun_layer/bin" > "$bun_layer/env/PATH.append"

# --- Mark layer metadata (cache + launch) ---
cat > "$bun_layer.toml" <<EOF
[types]
build = true
launch = true
cache = true
EOF

# --- Build steps ---
cd "$app_dir"

if [[ -f "package.json" ]]; then
  echo "Running bun install..."
  if [[ -f "bun.lockb" || -f "bun.lock" ]]; then
    "$bun_layer/bin/bun" install --frozen-lockfile
  else
    "$bun_layer/bin/bun" install
  fi

  # if script exists, run it
  if grep -q '"build"[[:space:]]*:' package.json; then
    echo "Running bun run build..."
    "$bun_layer/bin/bun" run build
  fi
fi

# --- Define launch process (web) ---
# Buildpack API supports writing launch.toml into layers dir:
cat > "$layers_dir/launch.toml" <<'EOF'
[[processes]]
type = "web"
command = "bun"
args = ["run", "start"]
default = true
EOF

echo "âœ… Bun buildpack complete."
